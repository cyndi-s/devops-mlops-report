name: mlops-plugin self-test
on:
  push:
  pull_request:
  workflow_dispatch:

jobs:
  mlops:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      actions: read
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0   # avoid HEAD^ errors in detect script

      - name: Run mlops-plugin (composite, no training in self-test)
        uses: ./action
        with:
          # MLflow / DagsHub creds (used by extract steps; training is disabled here)
          mlflow_tracking_uri: ${{ secrets.MLFLOW_TRACKING_URI }}
          mlflow_token:        ${{ secrets.DAGSHUB_TOKEN }}

          # Turn off training for this repo (no MLproject in plugin repo)
          train: 'false'

          # Optional Gist ledger (enable if you have these set)
          gist_id:       ${{ vars.GIST_ID }}
          gist_filename: commitHistory.csv
          gist_token:    ${{ secrets.GIST_TOKEN }}

          # For backward-compat only; ignored when train='false'
          trained_this_run: 'false'